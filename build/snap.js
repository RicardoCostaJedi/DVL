// Generated by CoffeeScript 1.6.2
var dvl;

dvl = require('./core');

module.exports = function(_arg) {
  var acc, data, name, out, trim, updateSnap, value;

  data = _arg.data, acc = _arg.acc, value = _arg.value, trim = _arg.trim, name = _arg.name;
  if (!data) {
    throw new Error('No data given');
  }
  acc = dvl.wrap(acc || dvl.identity);
  value = dvl.wrap(value);
  trim = dvl.wrap(trim || false);
  name || (name = 'snaped_data');
  out = dvl(null).name(name);
  updateSnap = function() {
    var a, d, dist, ds, i, minDatum, minDist, minIdx, v, _i, _len;

    ds = data.value();
    a = acc.value();
    v = value.value();
    if (ds && a && v) {
      ds = ds.valueOf();
      if (trim.value() && ds.length !== 0 && (v < a(ds[0]) || a(ds[ds.length - 1]) < v)) {
        minIdx = -1;
      } else {
        minIdx = -1;
        minDist = Infinity;
        if (ds) {
          for (i = _i = 0, _len = ds.length; _i < _len; i = ++_i) {
            d = ds[i];
            dist = Math.abs(a(d) - v);
            if (dist < minDist) {
              minDist = dist;
              minIdx = i;
            }
          }
        }
      }
      minDatum = minIdx < 0 ? null : ds[minIdx];
      if (out.value() !== minDatum) {
        out.set(minDatum);
      }
    } else {
      out.set(null);
    }
    return dvl.notify(out);
  };
  dvl.register({
    fn: updateSnap,
    listen: [data, acc, value, trim],
    change: [out],
    name: name + '_maker'
  });
  return out;
};
