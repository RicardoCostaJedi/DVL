<!DOCTYPE html>
<html>
  <head>
    <title>DVL Histogram Text</title>
    <link type="text/css"         href="../../css/smoothness/jquery-ui-1.8.7.custom.css" rel="Stylesheet" />
    <script type="text/javascript" src="../../js/jquery-1.6.2.min.js"></script>
    <script type="text/javascript" src="../../js/jquery-ui-1.8.7.custom.js"></script>
    <script type="text/javascript" src="../../d3.js"></script>
    <script type="text/javascript" src="../../protovis-r3.2.js"></script>
    <script type="text/javascript" src="../../sprintf.js"></script>
    <script type="text/javascript" src="../../dvl.js"></script>
    <script type="text/javascript" src="text.js"></script>
    <style type="text/css">

body {
  font: 12px sans-serif;
}

.background {
  fill: #ccc;
}

.lines {
  shape-rendering: crispEdges;
}

.bars {
  fill: steelblue;
}

    </style>

  </head>
  <body>
  </body>
  <script type="text/javascript">

  text = text.toUpperCase().replace(/[^A-Z]/g, '');

  var letters = dvl.const("ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(''));

  var data = dvl.def([], 'data');

	var getY = dvl.acc('letter');
	var getX = dvl.acc('count');
	var duration = 0;

  var width = 740;
  var height = 640;
	var padding = 30;

  var svg = d3.select('body')
    .append('svg')
    .attr('width',  width + padding * 2)
    .attr('height', height + padding * 2)

  var mainGroup = svg.append('g')
    .attr('transform', 'translate(' + padding + ',' + padding + ')')

  mainGroup.append('rect')
    .attr('class', 'background')
    .attr('width',  width )
    .attr('height', height)

  var sx = dvl.scale.linear({
    name: "scale_x",
    domain: { data:data, acc:getX },
    rangeFrom: 0,
    rangeTo: width,
    padding: 10,
    anchor: true
  })

  var sy = dvl.scale.ordinal({
    name: "scale_y",
    domain: { data:letters },
    rangeFrom: 0,
    rangeTo: height,
    padding: 10
  });

  var sizeY = dvl.apply({
    fn: function(b) { return 0.9 * b; },
    args: sy.band
  });

  var scaledX = dvl.chain(getX, sx.scale)
  var scaledY = dvl.chain(getY, sy.scale)
  var leftPos = dvl.apply({ args: dvl.zero, fn: sx.scale });
  var widthFn = dvl.apply({
    args: [scaledX, leftPos],
    fn: function(sx, lp) {
      return function(d,i) {
        return sx(d,i) - lp;
      }
    }
  });
  var yFn = dvl.apply({
    args: [scaledY, sy.band],
    fn: function(sy, b) {
      return function(d,i) {
        return sy(d,i) - b/2;
      }
    }
  });
  dvl.mark({
    type: 'rect',
    selection: mainGroup.append('g').attr('class', 'bars'),
    data: data,
    join: function(d) { return d.letter; },
    attr: {
      x: leftPos,
      y: yFn,
      width: widthFn,
      height: sizeY
    }
  });

  dvl.mark({
    type: 'line',
    selection: mainGroup.append('g').attr('class', 'lines'),
    data: sx.ticks,
    join: dvl.ident,
    attr: {
      x1: sx.scale,
      y1: 0,
      x2: sx.scale,
      y2: height,
    },
    style: {
      stroke: function(d,i) { return (d > 0 ? 'white' : 'black'); }
    }
  });

  dvl.mark({
    type: 'text',
    selection: mainGroup.append('g').attr('class', 'xlabels_top'),
    data: sx.ticks,
    join: dvl.ident,
    attr: {
      x: sx.scale,
      y: -3
    },
    style: {
      'text-anchor': 'middle'
    },
    text: function(d) { return d.toFixed(0); }
  });

  dvl.mark({
    type: 'text',
    selection: mainGroup.append('g').attr('class', 'xlabels_bottom').attr('transform', 'translate(0,' + height + ')'),
    data: sx.ticks,
    join: dvl.ident,
    attr: {
      x: sx.scale,
      y: 10,
      dy: 0.71
    },
    style: {
      'text-anchor': 'middle'
    },
    text: function(d) { return d.toFixed(0); }
  });

  dvl.mark({
    type: 'text',
    selection: mainGroup.append('g').attr('class', 'ylabels'),
    data: sy.ticks,
    join: dvl.ident,
    attr: {
      x: -3,
      y: sy.scale,
    },
    style: {
      'text-anchor': 'end'
    },
    text: dvl.ident
  });

  ////////////////////////////
  var pos = 0;
  var timer = setInterval(function() {
    if(pos >= text.length) {
      clearInterval(timer);
    } else {
      letter = text[pos];
      //console.log(pos, pair);
      ds = data.get();
      var found = false;
      for (var i=0; i < ds.length; i++) {
        if(ds[i].letter == letter) {
          ds[i].count += 1;
          found = true;
          break;
        }
      }
      if (!found) {
        data.push({
          letter: letter,
          count: 1
        });
      }
      data.notify();
      pos += 1;
    }
  }, 20);

  </script>
</html>
