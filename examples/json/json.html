<!DOCTYPE html>
<html>
  <head>
    <title>DVL JSON test</title>
    <link type="text/css"         href="base/css/smoothness/jquery-ui-1.8.7.custom.css" rel="Stylesheet" />	
    <script type="text/javascript" src="base/js/jquery-1.6.2.min.js"></script>
    <script type="text/javascript" src="base/js/jquery-ui-1.8.7.custom.js"></script>
    <script type="text/javascript" src="base/d3.js"></script>
    <script type="text/javascript" src="base/protovis-r3.2.js"></script>
    <script type="text/javascript" src="base/sprintf.js"></script>
    <script type="text/javascript" src="base/dvl.js"></script>

  </head>
  <body>
    <button onclick="v1.set(v1.get()+1).notify()">inc 1</button>
    <button onclick="v2.set(v2.get()+2).notify()">inc 2</button>
    <button onclick="dvl.notify( v1.set(v1.get()+1),v2.set(v2.get()+2) )">change 1 and 2</button>
    <button onclick="inter()">Run interference check</button>
    <button onclick="url1.set(null).notify()">url1 = null</button>
  </body>
  <script type="text/javascript">
  
  var v1 = dvl.def(100, 'value1');
  var v2 = dvl.def(240, 'value2');
  
  var data1 = dvl.apply({ args:v1, fn:function(v) { return 'expr=' + v + '&sleep=2000'; } });
  var data2 = dvl.apply({ args:v2, fn:function(v) { return 'expr=' + v + '&sleep=4000'; } });
  
  dvl.debug('data1', data1);
  dvl.debug('data2', data2);
  
  var groupId = dvl.ajax.getGroupId();
  var method = 'POST';
  
  var ret1 = dvl.ajax({ url:'http://localhost:8900/?a', data:data1, type:'json', groupId:groupId, method:method });
  var ret2 = dvl.ajax({ url:'http://localhost:8900/?b', data:data2, type:'json', groupId:groupId, method:method });

  var sum = dvl.apply({
    args: [ret1, ret2],
    fn: function(a, b) {
      return parseInt(a, 10) + parseInt(b, 10);
    }
  })

  dvl.debug("ret1", ret1);
  dvl.debug("ret2", ret2);
  dvl.debug("sum:", sum);
  
  
  var interUrl = dvl.def(null, 'inter');
  var interRes = dvl.ajax({ url:interUrl, type:'jsonp' });
  dvl.debug("inter:", interRes);
  
  function inter() {
    interUrl.set('http://localhost:8900?value=first&sleep=4000&callback=?').notify();
    setTimeout(function() {
      interUrl.set('http://localhost:8900?value=second&sleep=2000&callback=?').notify();
    }, 500);
  }
  
  </script>
</html>
